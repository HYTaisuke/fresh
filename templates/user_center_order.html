{% extends 'base_user_center.html' %}
{% load staticfiles %}
{% block right_content %}
    <div class="right_content clearfix">
        {% csrf_token %}
        <h3 class="common_title2">全部订单</h3>


        <ul class="order_list_th w978 clearfix">
            <li class="col01"></li>
            <li class="col02">订单号：</li>
            <li class="col02 stress"></li>
        </ul>

        <table class="order_list_table w980">
            <tbody>
            <tr>
                <td width="55%">

                    <ul class="order_goods_list clearfix">
                        <li class="col01"><img src=""></li>
                        <li class="col02"><em>元/</em></li>
                        <li class="col03"></li>
                        <li class="col04">元</li>
                    </ul>

                </td>
                <td width="15%">(含运费:)元</td>
                <td width="15%"></td>
                <td width="15%"><a href="javascript:;" order_id="" status="" class="oper_btn">去付款</a></td>
            </tr>
            </tbody>
        </table>


        <div class="pagenation">

            <a href=""> < 上一页</a>


            <a href="" class="active"></a>

            <a href=""></a>


            <a href="">下一页></a>

        </div>
    </div>
{% endblock %}

{% block bottomfiles %}
    <script src="{% static 'js/jquery-1.12.4.min.js' %}"></script>
    <script>
        $('.oper_btn').each(function () {
            // 获取status
            status = $(this).attr('status');
            if (status == 1) {
                $(this).text('去支付')
            } else if (status == 4) {
                $(this).text('去评价')
            } else if (status == 5) {
                $(this).text('已完成')
            }
        })


        $('.oper_btn').click(function () {
            // 获取status
            status = $(this).attr('status')
            // 获取订单id
            order_id = $(this).attr('order_id')
            if (status == 1) {
                // 进行支付
                csrf = $('input[name="csrfmiddlewaretoken"]').val()
                // 组织参数
                params = {'order_id': order_id, 'csrfmiddlewaretoken': csrf}
                // 发起ajax post请求, 访问/order/pay, 传递参数:order_id
                $.post('', params, function (data) {
                    if (data.res == 3) {
                        // 引导用户到支付页面
                        window.open(data.pay_url)
                        // 浏览器访问order/check,获取支付交易结果
                        // ajax post  传递参数:order_id
                        $.post('/order/check', params, function () {
                            if (data.res == 3) {
                                alert('支付成功')
                                //重新加载
                                location.reload()
                            } else {
                                alert(data.errmsg)
                            }
                        })
                    } else {
                        alert(data.errmsg)
                    }
                })
            } else if (status == 4) {
                //其他情况
                // 跳转到评价页面
                location.href = "/order/comment/" + order_id
            }
        })
    </script>
{% endblock bottomfiles %}